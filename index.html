<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com 
		https://github.com/SheetJS/js-xlsx
		https://stuk.github.io/jszip/
		https://oss.sheetjs.com/js-xlsx/
		https://www.pagecloud.com/blog/how-to-add-custom-fonts-to-any-website
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<title>Search SUN Spreadsheet</title>
<style>
	/*
	@font-face {
		font-family: "SUNBF78_909_EN";
		src: url("SUNBF78_909_EN.woff") format('woff'),
			  url("SUNBF78_909_EN.ttf") format(truetype);
	}
	@font-face {
		font-family: "SUN7_8_909";
		src: url("SUN7_8_909.woff") format('woff'),
			  url("SUN7_8_909.ttf") format(truetype);
	}

	*/
	@font-face {
		font-family: "SUNBF7_8_1210_EN";
		src: url("SUNBF7_8_1210_EN.woff") format('woff'),
			  url("SUNBF7_8_1210_EN.ttf") format(truetype);
	}
	@font-face {
		font-family: "SUN7_8_1210";
		src: url("SUN7_8_1210.woff") format('woff'),
			  url("SUN7_8_1210.ttf") format(truetype);
	}

	
	:root {
		--sun-font: 'SUN78_909';
	}
	
	html { height:100%; }
		
	body {
		height: 100%;
		width = 600px;
		line-height: normal;
		
	}
	#title {
		font-size: 20px;
		text-align: center;
		font-weight: bold;
	}
	
	#title label {
		font-size:12px;
	}
	
	footer {
		color: lightgray;
	}

	div.filetable {
		width: 100%
	}	
	
	#output {
		font-family: var(--sun-font); 
		height: 65%;
		overflow-y: scroll;
		scroll-behavior: smooth; 
	}
	
	#splitlabel {
		font-size: 10px;
		font-weight: bold;
	}
	#lblclear {
		font-size: 12px;
		font-weight: bold;
	}
	
	table.xreftable {
		 border-width: 1px;
		 border-spacing: 0;
		 border-style: outset;
		 border-color: black;
		 border-collapse: separate; 
		 background-color: white; 
		 font-size: 14px;
		 table-layout: fixed;
		 margin-bottom: 5px;
		 width: 100%; 
		 empty-cells: show;

	}
	
	.xreftable caption {
		color: green;
	}
	
	.xreftable tr {
		vertical-align: middle;
		padding-top: 5px;
	}

	.xreftable td, .xreftable th {
		border-width: 1px;
		padding: 1px;
		border-style: inset;
		border-color: lightblue;
		font-size: 14px;
		word-wrap: break-word;
		min-width: 25px;
	}

	.xreftable td.nameCol, .xreftable th.nameCol {
		 word-wrap: break-word;
		 width: 100px;
	}
	
	.xreftable td.synCol, .xreftable th.synCol {
		line-height: 15px;
		width: 120px;
	}
	.xreftable td.xrefCol, .xreftable th.xrefCol {
		/*vertical-align: top;*/
		line-height: 15px;
	}

	.xreftable td.fonticon {
		font-size: 32px;
		font-family: var(--sun-font); 
		vertical-align: middle;
		color: blue;
		width: 45px;
		height: 100%;
	}
	.xreftable th.fonticon {
		text-align: center;
		color: blue;
		width: 45px;
	}
	
	.xreftable td.unicol {
		text-align: center;
		font-size: 14px;
		font-family: var(--sun-font); 
		color: blue;
		width: 60px;
	}
	.xreftable th.unicol {
		text-align: center;
		color: blue;
		width: 60px;
	}

		

		 /*Table Even Rows Styles*/
	 .xreftable tbody, .xreftable tr:nth-child(even){
		 background-color: #efefef;
	 }

		 /*Table ODD Rows Styles*/
	 .xreftable tbody, .xreftable tr:nth-child(odd){
		 background-color: #dfdfdf;
	 }

		 /*Table Row HOver Style*/
	 .xreftable table, .xreftable tbody, .xreftable tr:hover{
		 background-color: #ffffd8;
	 }


	.uerror {
		  color: red;
	 }
	.nameerror {
		  color: gray;
	 }
	
	 

	#drop{
		border:2px dashed #bbb;
		border-radius:5px;
		padding:5px;
		text-align:center;
		font:20pt bold,"Vollkorn";color:#bbb
	}
	

	/* The Modal (background) */
	.modal {
	  display: none; /* Hidden by default */
	  position: fixed; /* Stay in place */
	  z-index: 1; /* Sit on top */
	  padding-top: 100px; /* Location of the box */
	  left: 0;
	  top: 0;
	  width: 100%; /* Full width */
	  height: 100%; /* Full height */
	  overflow: auto; /* Enable scroll if needed */
	  background-color: rgb(0,0,0); /* Fallback color */
	  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* Modal Content */
	.modal-content {
	  position: relative;
	  background-color: #eeeeee;
	  margin: auto;
	  padding: 0;
	  border: 1px solid #888;
	  border-radius:5px;
	  width: 300px;;
	  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
	  -webkit-animation-name: animatetop;
	  -webkit-animation-duration: 0.4s;
	  animation-name: animatetop;
	  animation-duration: 0.4s
	}

	/* Add Animation */
	@-webkit-keyframes animatetop {
	  from {top:-300px; opacity:0} 
	  to {top:0; opacity:1}
	}

	@keyframes animatetop {
	  from {top:-300px; opacity:0}
	  to {top:0; opacity:1}
	}

	/* The Close Button */
	.close {
	  color: white;
	  float: right;
	  font-size: 28px;
	  font-weight: bold;
	}

	.close:hover,
	.close:focus {
	  color: #000;
	  text-decoration: none;
	  cursor: pointer;
	}

	.modal-header {
	  padding: 1px 5px;
	  background-color: red;
	  color: white;
	  font-size: 28px;
	  font-weight: bold;
	}

	.modal-body {padding: 2px 16px;}

</style>
</head>
<body>

	<form >
		<div id="title">
			XREF Search<label style="float:right;">10.5</label>
		</div>
		<fieldset>
			<div style="padding-bottom:5px;">
				<label for="xlf" style="float:left;"> <strong>Select ODS, XLSX or CSV File:</strong></label>
				<input id="xlf"  type="file" name="xlfile" >
				<!--<label style="float:right;">Debug&nbsp
					<input type="checkbox" id="showdebug"  onclick="showDebug();">
				</label>-->
				<div id="drop">Or drop file here</div>
			</div>

			<div class="filetable" style="padding-bottom:5px;">
				<div style="padding-bottom:5px;">
					<!--<label for="sfont" style="float:left;"> <strong>Sun font&nbsp</strong></label>
					<input id='sfont' type='text' size="10">-->
					<select id = "selFont" onChange="optChangeFont()">
						   <option value = "SUNBF7_8_1210_EN"  >BACKSUN7_8_1210</option>
						   <option value = "SUN7_8_1210" selected>SUN7_8_1210</option>
					</select>
					
					
					<label style='float:center;' > <strong>&nbspSearch Type&nbsp</strong>
						<span id="radiospan" style="border:1px; border-style:solid; ">
							<input type="radio" id="wordsrch" name="wsrch" value="word" onClick="setSrch(true)" checked>
							<label for="wordsrch">Word</label>
							<input type="radio" id="charsrch" name="wsrch" value="char" onClick="setSrch(false)">
							<label for="charsrch">Char&nbsp</label>
						</span>
					</label>
					<!--<input type="button" id="showerr" style='float: right;' onclick="showError();"  >
					<label id="splitlabel" for="showerr" style='float: right;'> <strong>Errors<br>Only &nbsp  </strong></label>-->
										
				</div>

				<div >
					<label for="xsearch;" span style='float:left;'> <strong>Search Words &nbsp</strong></label>
						<input id='xsearch' onkeyup='search_Table("xref1")' type='text' size="40">

					<button type="submit"  onclick='clearTable()'<img> Clear</button>
					<button type="submit" style='float:right;' onclick='dnldCSV()'<img> Download CSV</button>
											
				</div>
			</div>
		</fieldset>
	</form>
	
<div>In the <b>Search</b> bar, enter words separated by space. Select Word in Search Type for full word search.  Select Char in Search Type for partial word search.

</div>

<div id="output">
&#174; &#xe000;
</div>

<footer>
    <center>
		<!--<font face="SUN7.24"> -->
      <p id="copyright">&copy; Wilbur Zirk 2020 &#xe000;
	  </p>
	 <!-- </font> -->
    </center>
  </footer>
<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <p>Error</p>
    </div>
    <div class="modal-body">
      <p id="mdisp" >Error on row</p>
	</div>
  </div>

</div>

<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<!-- <script src="js/cookie.js"></script> -->
<script src="js/table.js" id="tbl"></script>
<script src="js/modal.js"></script>
<script src="js/convertuni.js"></script>
<script src="sun.js" > </script>
<!-- https://stackoverflow.com/questions/1017424/pass-vars-to-javascript-via-the-src-attribute  -->
<!-- <script type="text/javascript" data-parameter_1="value_1" ... src="sun.js"></script>
-->

<script>
var debug = false;
var X = XLSX;
var CSV = false;
var global_wb;
var srchType = document.querySelector('input[name = wsrch]:checked').value
var colValues =[];


window.addEventListener('DOMContentLoaded', (event) => {
	console.log('DOM fully loaded')
	fval = document.getElementById('selFont').value;
	changeFont(fval);

});

/*
var csvData = 'Test Data\n'
+ '"","questioned","e061","mouth,said,speak: ?","ask"\n'
+ '"","ashamed","e05f","no,not: mouth: heart",\n'
+ '"","loaf","e05d","mouth,said,speak: grain,wheat","bread"\n'
+ '"","boy","e001","small,few: man",\n'
+ '"me poss","mine",,,"ours:my:our"\n'
+ '"","blaspheme","e05b","mouth,said,speak,confessiom: bad: no,not: good: king,crown,ruler,lord,master: man: love,compassion","insult:blasphemy"\n'
+ '"","Apelles","ebcd","man:split,divide,division,separate","looks_like"\n'
+ '"","Levi","eb1b","man: with: equal,same: people",\n'
+ '"","chariot","EC82","horse: chair,sit",\n'
+ '"","Cilicia","EB5B","hair: face: fabric,clothing: land,ground,earth",\n'
+ '"","Nahor","EC6E","man: air",\n';
*/

function fixUnicode(lines) {
	console.log('fix');
	var t0 = performance.now();

	for (var i = 0; i < lines.length; i ++) {
		rowx = lines[i]
			j = 0
			var uni = rowx[j];
			if (uni.length === 3) {
				var hArry = toHexArray(uni);
				uni = convertUTF82CP(hArry).toLowerCase();
				var char = unescape('%u' + uni);
				lines[i][j] = char;
			}
	}
	console.log('csvfix',lines);
	var t1 = performance.now();
	console.log("fixUnicode " + (t1 - t0) + " milliseconds.");
	return lines;
}

var process_wb = (function() {
	var OUT = document.getElementById('output');
	var to_csv = function to_csv(workbook) {
		var t0 = performance.now();
		var result = [];
		workbook.SheetNames.forEach(function(sheetName) {
			var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
			//var csv = X.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1, raw:true});
			if(csv.length){
				result.push("SHEET: " + sheetName);
				result.push("");
				result.push(csv);
			}
		});
		var t1 = performance.now();
		console.log("to_csv " + (t1 - t0) + " milliseconds.");
		return result.join("\n");
	};


	return function process_wb(wb) {
		var t0 = performance.now();
		console.log('process_wb')
		global_wb = wb;
		var output = "";
        csv = to_csv(wb);
		output = csvToArray(csv);
		console.log(output)
		if (CSV) output = fixUnicode(output);
		generateTable(output);
		//var ta = performance.now();
		//for ( i = 0; i < 3; i++){
		//table_mismatch();
		//}
		//sortTable();
		//var tb = performance.now();
		//console.log("2nd delay "+ (tb - ta) + " milliseconds.");
		var t1 = performance.now();
		console.log("process_wb "+ (t1 - t0) + " milliseconds.");
	};

})();

var do_file = (function() {
	return function do_file(files) {
		console.log('do_file');
		var t0 = performance.now();
		var rABS = false;
		var f = files[0];
		var fname = f["name"];
		var ext = fname.slice((fname.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
		if (ext === 'csv') CSV = true;
		else CSV = false;
		var reader = new FileReader();
		reader.onload = function(e) {
			var data = e.target.result;
			console.log(data);
			process_wb(X.read(data, {type:'array'}));
		};
		if(rABS) reader.readAsBinaryString(f);
		else {
			reader.readAsArrayBuffer(f);
		}
		var t1 = performance.now();
		console.log("do_file " + (t1 - t0) + " milliseconds.");
	};
})();

(function() {
	var drop = document.getElementById('drop');
	if(!drop.addEventListener) return;

	function handleDrop(e) {
		e.stopPropagation();
		e.preventDefault();
		do_file(e.dataTransfer.files);
	}

	function handleDragover(e) {
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = 'copy';
	}

	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
})();

(function() {
	var xlf = document.getElementById('xlf');
	if(!xlf.addEventListener) return;
	function handleFile(e) { do_file(e.target.files); }
	xlf.addEventListener('change', handleFile, false);
})();



//document.getElementById('sfont').value = "";
document.getElementById('xlf').value = ""; 

function optChangeFont() {
	fval = document.getElementById('selFont').value;
	getFont(fval);
}

function getFont(fval) {
	console.log('getFont',fval)
	changeFont(fval)
}


//https://stackoverflow.com/questions/11355147/font-face-changing-via-javascript
function fface(f) {
	ff = "@font-face { font-family: '" + f + "';\
		src: url('" + f + ".woff') format('woff'),\
		     url('" + f + ".ttf') format('truetype');\
	}"

	console.log(ff)
	return ff;
}

function changeFont(f) {
	ff = fface(f)
	var fStyle = document.getElementById("fontStyle")
	if (!fStyle) {
		fStyle = document.createElement('style');
		fStyle.id = "fontStyle"
		fStyle.appendChild(document.createTextNode(ff)
		);
			
		document.head.appendChild(fStyle);
	} else {
		fStyle.innerHTML = ff;
	}

	console.log(fStyle.innerHTML)
	document.documentElement.style.setProperty('--sun-font', f);
	
}

function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

function dnldCSV() {
	var name = csvData.substring(0, csvData.indexOf(".csv") + 4);
	var str = csvData.substring(csvData.indexOf("\n") + 1);
	var csvContent = replaceAll(str, '|', ',')
	var link = window.document.createElement("a");
	link.setAttribute("href", "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(csvContent));
	link.setAttribute("download", name);
	link.click(); 

}


function setSrch(e) {
	srchType = document.querySelector('input[name = wsrch]:checked').value
	search_Table()
}

function showDebug() {
	e =document.getElementById('showdebug').checked;
	if (e) {
		generateTable(jscsvToArray(csvData));
		//table_mismatch();
	} else {
		document.getElementById("output").innerHTML = ""
	}
}

generateTable(jscsvToArray(csvData));

/*
if (debug) {
	console.log(csvData)
	generateTable(csvToArray(csvData));
	table_mismatch();
	//sortTable();
}
*/

</script>
</body>
</html>
