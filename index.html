<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com 
		https://github.com/SheetJS/js-xlsx
		https://stuk.github.io/jszip/
		https://oss.sheetjs.com/js-xlsx/
		https://www.pagecloud.com/blog/how-to-add-custom-fonts-to-any-website
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<title>WoodShop Spreadsheet</title>

<style>
    @import url("css/woodshop.css");
    
	html { height:100%; }
		
	body {
		height: 100%;
		width = 600px;
		line-height: normal;
		
	}
	#title {
		font-size: 20px;
		text-align: center;
		font-weight: bold;
	}
	
	#title label {
		font-size:12px;
	}
	
	footer {
		color: lightgray;
	}
		
	div.filetable {
		width: 100%
	}	
	
	#output {
		font-family: var(--sun-font); 
		height: 65%;
		overflow-y: scroll;
		scroll-behavior: smooth; 
	}
	

</style>
</head>
<body>

	<form >
		<div id="title">
			Wood Shop Inventory<label style="float:right;">0.5</label>
		</div>
		<fieldset>
			<div style="padding-bottom:5px;">
				<label for="xlf" style="float:left;"> <strong>Select ODS, XLSX or CSV File:</strong></label>
				<input id="xlf"  type="file" name="xlfile" >
				<div id="drop">
					Or drop file here <span id="xlfd"> ---- </span>
				</div>
			</div>

			<div class="filetable" style="padding-bottom:5px;">
				<div style="padding-bottom:5px;">
					<label for="xsearch;" span style='float:left;'> <strong>Search Words &nbsp</strong></label>
						<input id='xsearch' onkeyup='search_Table("xref1")' type='text' size="40">

					<button type="submit"  onclick='clearTable()'<img> Clear</button>
					<button type="submit" style='float:right;' onclick='dnldCSV()'<img> Download CSV</button>

				<label style='float:center;' > <strong>&nbspSearch Type&nbsp</strong>
						<span id="radiospan" style="border:1px; border-style:solid; ">
							<input type="radio" id="wordsrch" name="wsrch" value="word" onClick="setSrch(false)" >
							<label for="wordsrch">Word</label>
							<input type="radio" id="charsrch" name="wsrch" value="char" onClick="setSrch(true)" checked>
							<label for="charsrch">Char&nbsp</label>
						</span>
					</label>
			</div>
		</fieldset>
	</form>
	
<div>In the <b>Search</b> bar, enter words separated by space. Select Word in Search Type for full word search.  Select Char in Search Type for partial word search.

</div>

<div id="output">
&#174; &#xe000;
</div>

<footer>
    <center>
		
      <p id="copyright">&copy; Wilbur Zirk 2021;
	  </p>

    </center>
  </footer>
<!-- The Modal 
<div id="myModal" class="modal">

  -- Modal content 
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <p>Error</p>
    </div>
    <div class="modal-body">
      <p id="mdisp" >Error on row</p>
	</div>
  </div>

</div>
-->

<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/gentable.js" id="tbl"></script>



<script>
var debug = false;
var X = XLSX;
var CSV = false;
var global_wb;
var srchType = document.querySelector('input[name = wsrch]:checked').value
var colValues =[];


window.addEventListener('DOMContentLoaded', (event) => {
	console.log('DOM fully loaded')
	//fval = document.getElementById('selFont').value;
	//changeFont(fval);

});


var xcsvData = 'Holmstad Wood Shop - Inventory,,,,,,,,,\n'+
'Date,,Sorted by Storage Box Number,,,,,,,\n'+
',,,,,,,,,\n'+
'"Box\n'+
'Number","Moved to\n'+
'Box #","No. of\n'+
'Items",Item Description,Sort Criteria,,"Price tag\n'+
'Each",,,\n'+
',,,General,Specific,Other,,,Item Maker,\n'+
'1,,6,"Spoons, wooden – large - 12”",Household,Kitchen/serve,,$4.00,,David L\n'+
'1.1,,2,"Spoons, wooden – 5”",Household,Kitchen/serve,,$4.00,,David L\n'+
'1.2,,6,"Spoons, wooden – 6” to 10”",Household,Kitchen/serve,,$4.00,,David L\n'+
'2,,4,"Cats, sitting on shelf – painted by Lupe",Decor,Knick-knack,Animal,$15.00,,Dave A\n'+
'3,,6,"Vases, bud type, bark ………",Decor,,,$10.00,,???\n'

var csvData = ',,,,,,,,,,,,\n'+
',,,"Holmstad Wood Shop – Inventory",,,,,,,,,\n'+
',,,"Date",,,"Sorted by Storage Box Number",,,,,,\n'+
',,,,,,,,,,,,\n'+
',,,"Box'+
'Number","Moved to'+
'Box #","No. of'+
'Items","Item Description","Sort Criteria",,,"Price tag'+
'Each",,\n'+
',,,,,,,"General","Specific","Other",,,"Item Maker"\n'+
',,,1,,6,"Spoons, wooden – large - 12”","Household","Kitchen/serve",,$4.00,,"David L"\n'+
',,,1.1,,2,"Spoons, wooden – 5”","Household","Kitchen/serve",,$4.00,,"David L"\n'+
',,,1.2,,6,"Spoons, wooden – 6” to 10”","Household","Kitchen/serve",,$4.00,,"David L"\n'+
',,,2,,4,"Cats, sitting on shelf – painted by Lupe","Decor","Knick-knack","Animal",$15.00,,"Dave A"\n'+
',,,3,,6,"Vases, bud type, bark ………","Decor",,,$10.00,,"???"\n';

//console.log(csvData)

var process_wb = (function() {
	var OUT = document.getElementById('output');
	var to_csv = function to_csv(workbook) {
		var t0 = performance.now();
		var result = [];
		workbook.SheetNames.forEach(function(sheetName) {
			var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
			//var csv = X.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1, raw:true});
			if(csv.length){
				result.push("SHEET: " + sheetName);
				result.push("");
				result.push(csv);
			}
		});
		var t1 = performance.now();
		console.log("to_csv " + (t1 - t0) + " milliseconds.");
		return result.join("\n");
	};


	return function process_wb(wb) {
		var t0 = performance.now();
		console.log('process_wb')
		global_wb = wb;
		var output = "";
        csv = to_csv(wb);
		output = csvToArray(csv);
		console.log(output)
		//if (CSV) output = fixUnicode(output);
		generateTable(output);
		//var ta = performance.now();
		//for ( i = 0; i < 3; i++){
		//table_mismatch();
		//}
		//sortTable();
		//var tb = performance.now();
		//console.log("2nd delay "+ (tb - ta) + " milliseconds.");
		var t1 = performance.now();
		console.log("process_wb "+ (t1 - t0) + " milliseconds.");
	};

})();

var do_file = (function() {
	return function do_file(files) {
		console.log('do_file');
		var t0 = performance.now();
		var rABS = false;
		var f = files[0];
		var fname = f["name"];
		document.getElementById('drop').innerHTML = fname; 
		var ext = fname.slice((fname.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
		if (ext === 'csv') CSV = true;
		else CSV = false;
		var reader = new FileReader();
		reader.onload = function(e) {
			var data = e.target.result;
			console.log(data);
			process_wb(X.read(data, {type:'array'}));
		};
		if(rABS) reader.readAsBinaryString(f);
		else {
			reader.readAsArrayBuffer(f);
		}
		var t1 = performance.now();
		console.log("do_file " + (t1 - t0) + " milliseconds.");
	};
})();

(function() {
	var drop = document.getElementById('drop');
	if(!drop.addEventListener) return;

	function handleDrop(e) {
		e.stopPropagation();
		e.preventDefault();
		do_file(e.dataTransfer.files);
	}

	function handleDragover(e) {
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = 'copy';
	}

	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
})();

(function() {
	var xlf = document.getElementById('xlf');
	if(!xlf.addEventListener) return;
	function handleFile(e) { do_file(e.target.files); }
	xlf.addEventListener('change', handleFile, false);
})();



document.getElementById('xlf').value = ""; 
/*
function optChangeFont() {
	fval = document.getElementById('selFont').value;
	getFont(fval);
}

function getFont(fval) {
	console.log('getFont',fval)
	changeFont(fval)
}


//https://stackoverflow.com/questions/11355147/font-face-changing-via-javascript
function fface(f) {
	ff = "@font-face { font-family: '" + f + "';\
		src: url('" + f + ".woff') format('woff'),\
		     url('" + f + ".ttf') format('truetype');\
	}"

	console.log(ff)
	return ff;
}

function changeFont(f) {
	ff = fface(f)
	var fStyle = document.getElementById("fontStyle")
	if (!fStyle) {
		fStyle = document.createElement('style');
		fStyle.id = "fontStyle"
		fStyle.appendChild(document.createTextNode(ff)
		);
			
		document.head.appendChild(fStyle);
	} else {
		fStyle.innerHTML = ff;
	}

	console.log(fStyle.innerHTML)
	document.documentElement.style.setProperty('--sun-font', f);
	
}
*/
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

function dnldCSV() {
	var name = csvData.substring(0, csvData.indexOf(".csv") + 4);
	var str = csvData.substring(csvData.indexOf("\n") + 1);
	var csvContent = replaceAll(str, '|', ',')
	var link = window.document.createElement("a");
	link.setAttribute("href", "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(csvContent));
	link.setAttribute("download", name);
	link.click(); 

}


function setSrch(e) {
	srchType = document.querySelector('input[name = wsrch]:checked').value
	search_Table()
}

ary = csvToArray(csvData)
console.log(ary)
//ary = removeLeading3(ary)
generateTable(ary);

/*
if (debug) {
	console.log(csvData)
	generateTable(csvToArray(csvData));
	table_mismatch();
	//sortTable();
}
*/

</script>
</body>
</html>
